#cloud-config
# Simplified Omakub Development VM - Fully Automated Ubuntu 24.04 + Omakub
# This cloud-init configuration handles the complete setup automatically

# System configuration
hostname: {{ cloud_init_hostname }}
timezone: {{ cloud_init_timezone }}
locale: en_US.UTF-8
keyboard:
  layout: us

# User configuration
users:
  - name: {{ cloud_init_user }}
    plain_text_passwd: {{ cloud_init_password }}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: [sudo, adm, cdrom, dip, plugdev, lpadmin, sambashare]
    shell: /bin/bash
    lock_passwd: false
    ssh_authorized_keys:
      - {{ cloud_init_ssh_public_key }}

# SSH configuration
ssh_pwauth: true
disable_root: true
chpasswd:
  expire: false

# Package management
package_update: true
package_upgrade: true
packages:
  - curl
  - wget
  - git
  - software-properties-common
  - ubuntu-desktop-minimal
  - gnome-shell
  - gdm3
  - firefox

# Network configuration (static IP)
write_files:
  - path: /etc/netplan/01-netcfg.yaml
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          {{ network_config.interface }}:
            addresses:
              - {{ network_config.ip_address }}/24
            gateway4: {{ network_config.gateway }}
            nameservers:
              addresses:
{% for dns in network_config.dns_servers %}
                - {{ dns }}
{% endfor %}
    permissions: '0644'

  - path: /etc/ssh/sshd_config.d/50-cloud-init.conf
    content: |
      PasswordAuthentication yes
      PubkeyAuthentication yes
    permissions: '0644'

# Complete automated setup
runcmd:
  # Apply network configuration
  - netplan apply
  - systemctl restart ssh

  # Configure desktop environment
  - systemctl enable gdm3
  - systemctl set-default graphical.target

  # Configure git globally
  - sudo -u {{ cloud_init_user }} git config --global user.name "{{ git_user_name }}"
  - sudo -u {{ cloud_init_user }} git config --global user.email "{{ git_user_email }}"

  # Install Omakub automatically (runs in user session after desktop is ready)
  - |
    cat > /home/{{ cloud_init_user }}/install-omakub.sh << 'EOF'
    #!/bin/bash
    set -e
    echo "$(date): Starting Omakub installation" | tee -a /home/{{ cloud_init_user }}/omakub.log
    export DEBIAN_FRONTEND=noninteractive
    cd /home/{{ cloud_init_user }}
    wget -qO- https://omakub.org/install | bash 2>&1 | tee -a /home/{{ cloud_init_user }}/omakub.log
    echo "$(date): Omakub installation complete" | tee -a /home/{{ cloud_init_user }}/omakub.log
    EOF

  - chmod +x /home/{{ cloud_init_user }}/install-omakub.sh
  - chown {{ cloud_init_user }}:{{ cloud_init_user }} /home/{{ cloud_init_user }}/install-omakub.sh

  # Create systemd service to run Omakub installation after desktop starts
  - |
    cat > /etc/systemd/system/omakub-install.service << 'EOF'
    [Unit]
    Description=Omakub Installation Service
    After=graphical-session.target
    Wants=graphical-session.target

    [Service]
    Type=oneshot
    User={{ cloud_init_user }}
    Group={{ cloud_init_user }}
    WorkingDirectory=/home/{{ cloud_init_user }}
    ExecStart=/home/{{ cloud_init_user }}/install-omakub.sh
    StandardOutput=append:/home/{{ cloud_init_user }}/omakub.log
    StandardError=append:/home/{{ cloud_init_user }}/omakub.log

    [Install]
    WantedBy=graphical.target
    EOF

  - systemctl enable omakub-install.service

# Final message
final_message: |
  ðŸŽ‰ Omakub Development VM Setup Complete!

  Connection: ssh {{ cloud_init_user }}@{{ network_config.ip_address }}
  Password: {{ cloud_init_password }}

  Omakub will install automatically after first desktop login.
  Check ~/omakub.log for installation progress.

# Reboot to apply all changes
power_state:
  mode: reboot
  delay: 30
  message: "Rebooting to complete setup"