---
# Simplified Omakub Dev VM Role
# Generates cloud-init configuration for fully automated Ubuntu 24.04 + Omakub installation
# Terraform handles VM provisioning, cloud-init handles all automation

- name: Display Omakub VM configuration
  ansible.builtin.debug:
    msg: |
      🚀 Simplified Omakub Development VM Setup

      VM Details:
      - VM ID: {{ omakub_vm.id }}
      - VM Name: {{ omakub_vm.name }}
      - IP Address: {{ omakub_vm.ip }}
      - User: {{ cloud_init_user }}

      Features:
      - Fully automated Ubuntu 24.04 + GNOME installation
      - Automated Omakub development environment setup
      - Static IP configuration ({{ omakub_vm.ip }})
      - SSH access with key authentication
      - {{ omakub_vm_cores }} CPU cores, {{ (omakub_vm_balloon / 1024) | round(1) }}GB RAM

      Method: Pure cloud-init automation (no manual intervention required)

- name: Create cloud-init configuration directory
  ansible.builtin.file:
    path: "/tmp/cloud-init-omakub-{{ omakub_vm.id }}"
    state: directory
    mode: '0755'

- name: Generate cloud-init user-data configuration
  ansible.builtin.template:
    src: cloud-init-user-data.yml.j2
    dest: "/tmp/cloud-init-omakub-{{ omakub_vm.id }}/user-data"
    mode: '0644'
  register: cloud_init_generated

- name: Create cloud-init meta-data
  ansible.builtin.copy:
    content: |
      instance-id: omakub-vm-{{ omakub_vm.id }}
      local-hostname: {{ cloud_init_hostname }}
    dest: "/tmp/cloud-init-omakub-{{ omakub_vm.id }}/meta-data"
    mode: '0644'

- name: Display cloud-init configuration path
  ansible.builtin.debug:
    msg: |
      ✅ Cloud-init configuration generated successfully

      📁 Configuration location: /tmp/cloud-init-omakub-{{ omakub_vm.id }}/
      📄 Files created:
        - user-data (Ubuntu + Omakub automation)
        - meta-data (VM instance information)

      🎯 Next steps:
      1. Use Terraform to provision VM with cloud-init
      2. VM will automatically install Ubuntu 24.04 + GNOME
      3. Omakub will install automatically after desktop starts
      4. SSH access: ssh {{ cloud_init_user }}@{{ omakub_vm.ip }}

      ⚡ No manual intervention required!