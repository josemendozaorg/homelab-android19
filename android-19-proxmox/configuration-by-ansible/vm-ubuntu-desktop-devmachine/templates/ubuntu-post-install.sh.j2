#!/bin/bash
# Ubuntu Desktop Post-Install Automation Script
# Configures static IP, SSH, git, and sets up Omakub for first login

set -e

echo "ðŸš€ Ubuntu Desktop Post-Install Setup"
echo "===================================="

# Check if running as the correct user
if [ "$USER" != "{{ dev_user }}" ]; then
    echo "âŒ This script should be run as user: {{ dev_user }}"
    echo "Current user: $USER"
    exit 1
fi

echo "âœ… Running as correct user: {{ dev_user }}"

# Create log file
LOG_FILE="$HOME/ubuntu-post-install.log"
echo "ðŸ“ Logging to: $LOG_FILE"

# Function to log and execute
log_and_run() {
    echo "$(date): $1" | tee -a "$LOG_FILE"
    eval "$1" 2>&1 | tee -a "$LOG_FILE"
}

echo "ðŸ”§ Step 1/4: Setting up static IP configuration..."
log_and_run "sudo bash -c 'cat > /etc/netplan/01-netcfg.yaml << EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    {{ network_config.interface }}:
      addresses:
        - {{ network_config.ip_address }}/24
      gateway4: {{ network_config.gateway }}
      nameservers:
        addresses:
{% for dns in network_config.dns_servers %}
          - {{ dns }}
{% endfor %}
EOF'"

log_and_run "sudo netplan apply"
echo "âœ… Static IP configured: {{ network_config.ip_address }}"

echo "ðŸ”‘ Step 2/4: Setting up SSH access..."
log_and_run "mkdir -p ~/.ssh"
log_and_run "chmod 700 ~/.ssh"

# Add SSH public key
cat >> ~/.ssh/authorized_keys << 'EOF'
{{ ssh_public_key }}
EOF

log_and_run "chmod 600 ~/.ssh/authorized_keys"

# Ensure SSH service is enabled and running
log_and_run "sudo systemctl enable ssh"
log_and_run "sudo systemctl start ssh"

echo "âœ… SSH access configured"

echo "ðŸ‘¤ Step 3/4: Setting up user configuration..."
log_and_run "git config --global user.name '{{ git_user_name }}'"
log_and_run "git config --global user.email '{{ git_user_email }}'"
echo "âœ… Git configuration complete"

echo "ðŸŽ¯ Step 4/4: Setting up Omakub first-login installation..."

# Create Omakub installation script that runs on first GUI login
cat > ~/.omakub-first-login.sh << 'EOF'
#!/bin/bash
# Omakub installation script - runs on first GUI login

OMAKUB_LOG="$HOME/omakub-install.log"

if [ ! -f "$HOME/.omakub-completed" ]; then
    echo "$(date): Starting Omakub installation on first GUI login" | tee -a "$OMAKUB_LOG"

    # Ensure we're in a GUI session
    if [ -n "$DISPLAY" ] || [ -n "$WAYLAND_DISPLAY" ]; then
        echo "$(date): GUI session detected, proceeding with Omakub installation" | tee -a "$OMAKUB_LOG"

        # Download and run Omakub
        cd "$HOME"
        wget -qO- https://omakub.org/install | bash 2>&1 | tee -a "$OMAKUB_LOG"

        # Mark as completed
        touch "$HOME/.omakub-completed"
        echo "$(date): Omakub installation completed" | tee -a "$OMAKUB_LOG"

        # Show notification
        notify-send "Omakub Installation" "Development environment setup complete!"
    else
        echo "$(date): No GUI session detected, skipping Omakub installation" | tee -a "$OMAKUB_LOG"
    fi
fi
EOF

chmod +x ~/.omakub-first-login.sh

# Add to .profile for automatic execution on login
if ! grep -q ".omakub-first-login.sh" ~/.profile 2>/dev/null; then
    echo "" >> ~/.profile
    echo "# Auto-run Omakub installation on first GUI login" >> ~/.profile
    echo "~/.omakub-first-login.sh &" >> ~/.profile
fi

echo "âœ… Omakub first-login script configured"

echo ""
echo "ðŸŽ‰ Ubuntu Desktop Post-Install Setup Complete!"
echo "=============================================="
echo ""
echo "ðŸ“Š Configuration Summary:"
echo "  - Static IP: {{ network_config.ip_address }}"
echo "  - SSH access: ssh {{ dev_user }}@{{ network_config.ip_address }}"
echo "  - Git configured for: {{ git_user_name }} <{{ git_user_email }}>"
echo "  - Omakub: Will install automatically on next GUI login"
echo ""
echo "ðŸŽ¯ Next Steps:"
echo "  1. Reboot the system: sudo reboot"
echo "  2. Log into the desktop GUI"
echo "  3. Omakub will install automatically"
echo "  4. Check progress: tail -f ~/omakub-install.log"
echo ""
echo "âœ… Ready for development work!"