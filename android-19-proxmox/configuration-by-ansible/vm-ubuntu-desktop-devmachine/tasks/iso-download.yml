---
# Ubuntu Desktop ISO Download Tasks

- name: Display ISO download status
  ansible.builtin.debug:
    msg: |
      📦 Ubuntu Desktop ISO Download

      Downloading: {{ ubuntu_desktop_iso_name }}
      From: {{ ubuntu_desktop_iso_url }}
      To: {{ iso_storage_path }}/

- name: Ensure ISO storage directory exists
  ansible.builtin.file:
    path: "{{ iso_storage_path }}"
    state: directory
    mode: '0755'

- name: Check if Ubuntu Desktop ISO already exists
  ansible.builtin.stat:
    path: "{{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}"
  register: iso_file

- name: Display existing ISO status
  ansible.builtin.debug:
    msg: |
      ✅ Ubuntu Desktop ISO already exists
      📁 Location: {{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}
      📊 Size: {{ (iso_file.stat.size / 1024 / 1024 / 1024) | round(2) }}GB
      ⏭️ Skipping download
  when: iso_file.stat.exists

- name: Download Ubuntu Desktop ISO
  ansible.builtin.get_url:
    url: "{{ ubuntu_desktop_iso_url }}"
    dest: "{{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}"
    mode: '0644'
    timeout: 3600  # 1 hour timeout for large ISO
  register: iso_download
  when: not iso_file.stat.exists

- name: Display download completion
  ansible.builtin.debug:
    msg: |
      ✅ Ubuntu Desktop ISO download completed
      📁 Location: {{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}
      🎯 Ready for VM installation
  when: iso_download.changed

- name: Verify ISO is available in Proxmox storage
  ansible.builtin.command: pvesm list {{ proxmox_iso_storage }}
  register: storage_list
  changed_when: false

- name: Confirm ISO is available for VM creation
  ansible.builtin.assert:
    that:
      - ubuntu_desktop_iso_name in storage_list.stdout
    fail_msg: "ISO not found in Proxmox storage {{ proxmox_iso_storage }}. Check storage configuration."
    success_msg: "✅ Ubuntu Desktop ISO successfully available in Proxmox storage"