---
# Ubuntu Desktop ISO Download Tasks

- name: Display ISO download status
  ansible.builtin.debug:
    msg: |
      ğŸ“¦ Ubuntu Desktop ISO Download

      Downloading: {{ ubuntu_desktop_iso_name }}
      From: {{ ubuntu_desktop_iso_url }}
      To: {{ iso_storage_path }}/

- name: Ensure ISO storage directory exists
  ansible.builtin.file:
    path: "{{ iso_storage_path }}"
    state: directory
    mode: '0755'

- name: Check if Ubuntu Desktop ISO already exists
  ansible.builtin.stat:
    path: "{{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}"
  register: iso_file

- name: Display existing ISO status
  ansible.builtin.debug:
    msg: |
      âœ… Ubuntu Desktop ISO already exists
      ğŸ“ Location: {{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}
      ğŸ“Š Size: {{ (iso_file.stat.size / 1024 / 1024 / 1024) | round(2) }}GB
      â­ï¸ Skipping download
  when: iso_file.stat.exists

- name: Download Ubuntu Desktop ISO (async)
  ansible.builtin.get_url:
    url: "{{ ubuntu_desktop_iso_url }}"
    dest: "{{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}"
    mode: '0644'
  async: 3600  # 1 hour timeout
  poll: 0      # Start async, don't wait
  register: iso_download_async
  when: not iso_file.stat.exists

- name: Wait for Ubuntu Desktop ISO download to complete
  ansible.builtin.debug:
    msg: |
      ğŸ“¥ Starting Ubuntu Desktop ISO download monitoring...
      â±ï¸  Will check progress every 15 seconds (max 1 hour)
      ğŸ“ Target: {{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}
      ğŸ’¾ Size: ~6GB (Ubuntu 24.04.1 Desktop)
  when: iso_download_async.changed | default(false)

- name: Monitor Ubuntu Desktop ISO download progress
  ansible.builtin.async_status:
    jid: "{{ iso_download_async.ansible_job_id }}"
  register: iso_download_result
  until: iso_download_result.finished
  retries: 240  # 240 * 15 seconds = 1 hour
  delay: 15     # Check every 15 seconds
  when: iso_download_async.changed | default(false)

- name: Display download completion
  ansible.builtin.debug:
    msg: |
      âœ… Ubuntu Desktop ISO download completed successfully!
      ğŸ“ Location: {{ iso_storage_path }}/{{ ubuntu_desktop_iso_name }}
      ğŸ¯ Ready for VM installation
  when: iso_download_result.changed | default(false)

- name: Verify ISO is available in Proxmox storage
  ansible.builtin.command: pvesm list {{ proxmox_iso_storage }}
  register: storage_list
  changed_when: false

- name: Confirm ISO is available for VM creation
  ansible.builtin.assert:
    that:
      - ubuntu_desktop_iso_name in storage_list.stdout
    fail_msg: "ISO not found in Proxmox storage {{ proxmox_iso_storage }}. Check storage configuration."
    success_msg: "âœ… Ubuntu Desktop ISO successfully available in Proxmox storage"