---
# vm-coolify Role
# Coolify Platform - Self-hosted PaaS for application deployment with automatic SSL and GitHub integration

- name: Display VM configuration from catalog
  ansible.builtin.debug:
    msg: |
      ðŸš€ Configuring Coolify Platform VM

      ðŸ“‹ VM Configuration (from infrastructure-catalog.yml):
      - VM ID: {{ vm_config.id | default('160') }}
      - VM Name: {{ vm_config.name }}
      - IP Address: {{ vm_config.ip }}
      - CPU: {{ vm_config.resources.cores }} cores
      - RAM: {{ (vm_config.resources.memory / 1024) | round(1) }}GB
      - Disk: {{ vm_config.resources.disk }}GB
      - Cloud-init: {{ vm_config.cloud_init | default(false) }}

      ðŸŽ¯ Coolify Configuration:
      - Web UI Port: {{ coolify_web_port }}
      - Domain: {{ coolify_domain }}
      - Traefik Enabled: {{ traefik_enabled }}
      - Let's Encrypt Staging: {{ letsencrypt_staging }}

# Verify cloud-init completed successfully before proceeding
- name: Include cloud-init verification tasks
  ansible.builtin.include_tasks: verify-cloudinit.yml

# Install Docker and Docker Compose
- name: Include Docker installation tasks
  ansible.builtin.include_tasks: install-docker.yml

# Install Coolify platform
- name: Include Coolify installation tasks
  ansible.builtin.include_tasks: install-coolify.yml

# Generate or validate Coolify API token
- name: Include API token generation tasks
  ansible.builtin.include_tasks: generate-api-token.yml
  tags: [coolify, api-token]

# Configure wildcard domain for automatic subdomain generation
- name: Include wildcard domain configuration tasks
  ansible.builtin.include_tasks: configure-wildcard-domain.yml
  tags: [coolify, wildcard-domain]

# Configure GitHub App source for repository deployments
- name: Include GitHub source configuration tasks
  ansible.builtin.include_tasks: configure-github-source.yml
  tags: [coolify, github-source]

# GitHub App Manifest Flow - Semi-automated app creation (optional)
- name: Include GitHub App manifest generator tasks
  ansible.builtin.include_tasks: create-github-app-manifest.yml
  tags: [coolify, github-manifest]

# GitHub App Manifest Flow - Process callback code (run separately with --tags github-callback)
- name: Include GitHub App callback handler tasks
  ansible.builtin.include_tasks: handle-github-app-callback.yml
  tags: [coolify, github-callback]
  when: github_app_code is defined

# TODO: Implement remaining tasks
# - Traefik reverse proxy setup
# - Network configuration
