---
# vm-coolify Role
# Coolify Platform - Self-hosted PaaS for application deployment with automatic SSL and GitHub integration

- name: Display VM configuration from catalog
  ansible.builtin.debug:
    msg: |
      üöÄ Configuring Coolify Platform VM

      üìã VM Configuration (from infrastructure-catalog.yml):
      - VM ID: {{ vm_config.id | default('160') }}
      - VM Name: {{ vm_config.name }}
      - IP Address: {{ vm_config.ip }}
      - CPU: {{ vm_config.resources.cores }} cores
      - RAM: {{ (vm_config.resources.memory / 1024) | round(1) }}GB
      - Disk: {{ vm_config.resources.disk }}GB
      - Cloud-init: {{ vm_config.cloud_init | default(false) }}

      üéØ Coolify Configuration:
      - Web UI Port: {{ coolify_web_port }}
      - Domain: {{ coolify_domain }}
      - Traefik Enabled: {{ traefik_enabled }}
      - Let's Encrypt Staging: {{ letsencrypt_staging }}

# Verify cloud-init completed successfully before proceeding
- name: Include cloud-init verification tasks
  ansible.builtin.include_tasks: verify-cloudinit.yml

# Configure Host DNS to use AdGuard Home
- name: Include DNS configuration tasks
  ansible.builtin.include_tasks: dns-configure.yml
  tags: [coolify, dns, network]

# Include Node Exporter for Monitoring
- name: Include Node Exporter
  include_tasks: ../../common/tasks/install-node-exporter.yml
  tags: [monitoring, node_exporter]

# Install Docker and Docker Compose
- name: Include Docker installation tasks
  ansible.builtin.include_tasks: install-docker.yml

# Configure Docker to use AdGuard Home DNS for containers
- name: Include Docker DNS configuration tasks
  ansible.builtin.include_tasks: configure-docker-dns.yml
  tags: [coolify, docker, dns]

# Verify DNS resolution before proceeding with Coolify
- name: Include DNS verification tasks
  ansible.builtin.include_tasks: dns-verify.yml
  tags: [coolify, dns, verify]

# Install Coolify platform
- name: Include Coolify installation tasks
  ansible.builtin.include_tasks: install-coolify.yml

# Configure Traefik Proxy (Dashboard Access)
- name: Include Traefik proxy configuration tasks
  ansible.builtin.include_tasks: configure-proxy.yml
  tags: [coolify, proxy]

# Generate or validate Coolify API token
- name: Include API token generation tasks
  ansible.builtin.include_tasks: generate-api-token.yml
  tags: [coolify, api-token]

# Configure wildcard domain for automatic subdomain generation
- name: Include wildcard domain configuration tasks
  ansible.builtin.include_tasks: configure-wildcard-domain.yml
  tags: [coolify, wildcard-domain]

# Configure GitHub App source for repository deployments
- name: Include GitHub source configuration tasks
  ansible.builtin.include_tasks: configure-github-source.yml
  tags: [coolify, github-source]

# GitHub App Manifest Flow - Semi-automated app creation (optional)
- name: Include GitHub App manifest generator tasks
  ansible.builtin.include_tasks: create-github-app-manifest.yml
  tags: [coolify, github-manifest]

# GitHub App Manifest Flow - Process callback code (run separately with --tags github-callback)
- name: Include GitHub App callback handler tasks
  ansible.builtin.include_tasks: handle-github-app-callback.yml
  tags: [coolify, github-callback]
  when: github_app_code is defined

- name: Display deployment summary
  ansible.builtin.debug:
    msg: |
      üéâ Coolify Platform Configuration Complete!

      ‚úÖ VM Details:
      - VM ID: 160
      - Name: {{ vm_config.name }}
      - IP Address: {{ vm_config.ip }}
      - DNS Name: http://{{ coolify_domain }}:8000

      ‚úÖ DNS Configuration:
      - Host DNS: Configured to {{ catalog.network.dns }}
      - Docker DNS: Configured to {{ catalog.network.dns }}
      - Deployed apps will automatically resolve .homelab domains

      üöÄ Services are configured for auto-start on boot
      üåê Ready for application deployments!
