---
# Coolify installation tasks
# Install Coolify platform using official installation script

- name: Check if Coolify container already exists
  ansible.builtin.shell: docker ps -a --filter "name=coolify" --format {% raw %}'{{.Names}}'{% endraw %}
  register: coolify_container_check
  changed_when: false
  failed_when: false

- name: Download Coolify installation script
  ansible.builtin.get_url:
    url: "{{ coolify_install_script_url }}"
    dest: /tmp/coolify-install.sh
    mode: '0755'
  when: coolify_container_check.stdout == ""
  become: yes

- name: Execute Coolify installation script with admin credentials
  ansible.builtin.shell: |
    ROOT_USERNAME="{{ coolify_admin_username }}" \
    ROOT_USER_EMAIL="{{ coolify_admin_email }}" \
    ROOT_USER_PASSWORD="{{ coolify_admin_password }}" \
    /tmp/coolify-install.sh
  when: coolify_container_check.stdout == ""
  become: yes
  register: coolify_install_result

- name: Wait for Coolify container to start
  ansible.builtin.shell: docker ps --filter "name=coolify" --filter "status=running" --format {% raw %}'{{.Names}}'{% endraw %}
  register: coolify_running
  retries: 30
  delay: 2
  until: "'coolify' in coolify_running.stdout"
  changed_when: false

- name: Verify Coolify container is running
  ansible.builtin.assert:
    that:
      - "'coolify' in coolify_running.stdout"
    fail_msg: "Coolify container is not running"
    success_msg: "Coolify is running in Docker container"

- name: Display Coolify admin credentials
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Coolify Initial Admin Credentials"
      - "=========================================="
      - "Web UI: http://{{ hostvars[inventory_hostname].ansible_host }}:{{ coolify_web_port }}"
      - "Username: {{ coolify_admin_username }}"
      - "Email: {{ coolify_admin_email }}"
      - "Password: {{ coolify_admin_password }}"
      - "=========================================="
      - "⚠️  SAVE THESE CREDENTIALS IMMEDIATELY!"
      - "Password is randomly generated and won't be shown again"
      - "=========================================="
  when: coolify_install_result is changed
