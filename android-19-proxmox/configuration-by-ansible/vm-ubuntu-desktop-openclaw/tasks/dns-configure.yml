---
# DNS Configuration Tasks via QEMU Guest Agent
# Configure VM to use AdGuard Home DNS server

- name: Display DNS configuration start
  ansible.builtin.debug:
    msg: |
      üåê Configuring DNS to use AdGuard Home

      DNS Server: {{ catalog.network.dns }}
      VM ID: {{ vm_id }}

- name: Get current DNS configuration
  ansible.builtin.command:
    cmd: "qm guest exec {{ vm_id }} -- resolvectl status"
  register: current_dns
  failed_when: false
  changed_when: false

- name: Get NetworkManager connection name for primary interface
  ansible.builtin.shell:
    cmd: "qm guest exec {{ vm_id }} -- nmcli -t -f NAME,DEVICE connection show | python3 -c 'import sys, json; data=json.load(sys.stdin); lines=data[\"out-data\"].strip().split(\"\\n\"); print([line.split(\":\")[0] for line in lines if \"enp6s18\" in line][0])'"
  register: nm_connection
  changed_when: false

- name: Set connection name variable
  ansible.builtin.set_fact:
    network_connection: "{{ nm_connection.stdout | trim }}"

- name: Configure NetworkManager to use AdGuard DNS
  ansible.builtin.command:
    cmd: "qm guest exec {{ vm_id }} -- nmcli connection modify '{{ network_connection }}' ipv4.dns '{{ catalog.network.dns }}'"
  register: dns_configured
  changed_when: dns_configured.rc == 0

- name: Set DNS priority to manual
  ansible.builtin.command:
    cmd: "qm guest exec {{ vm_id }} -- nmcli connection modify '{{ network_connection }}' ipv4.ignore-auto-dns yes"
  register: dns_priority
  changed_when: dns_priority.rc == 0

- name: Note - NetworkManager applies DNS changes automatically
  ansible.builtin.debug:
    msg: "DNS settings applied. NetworkManager will use new DNS configuration automatically (no reload required)."

- name: Wait for DNS changes to propagate
  ansible.builtin.pause:
    seconds: 2

- name: Verify DNS configuration
  ansible.builtin.command:
    cmd: "qm guest exec {{ vm_id }} -- resolvectl status"
  register: new_dns
  failed_when: false
  changed_when: false

- name: Test DNS resolution
  ansible.builtin.command:
    cmd: "qm guest exec {{ vm_id }} -- nslookup proxmox.homelab"
  register: dns_test
  failed_when: false
  changed_when: false

- name: Display DNS configuration summary
  ansible.builtin.debug:
    msg: |
      ‚úÖ DNS Configuration Complete

      DNS Server: {{ catalog.network.dns }}
      Test: {{ 'PASS' if dns_test.rc == 0 else 'FAIL' }}

      To verify on VM:
      - resolvectl status
      - nslookup proxmox.homelab
