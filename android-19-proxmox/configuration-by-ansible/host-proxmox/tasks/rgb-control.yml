---
# RGB/LED Light Control Tasks for Arctic Fans, CPU Cooler, and RAM
#
# This task file manages RGB lighting on the Proxmox host hardware:
# - Arctic fans
# - Arctic CPU cooler
# - RAM modules
#
# RGB control tasks will be implemented here to:
# - Install RGB control software (OpenRGB/liquidctl)
# - Detect RGB hardware components
# - Turn lights on/off based on rgb_lights_state variable
# - Configure persistence across reboots via systemd service
#
# Tasks are executed when rgb_lights_enabled is true

- name: Detect if OpenRGB is already installed
  command: which openrgb
  register: openrgb_installed
  failed_when: false
  changed_when: false
  tags:
    - rgb
    - detection

- name: Create OpenRGB installation directory
  file:
    path: /usr/local/bin
    state: directory
    mode: '0755'
  become: true
  when: openrgb_installed.rc != 0
  tags:
    - rgb
    - installation

- name: Download OpenRGB AppImage
  get_url:
    url: https://openrgb.org/releases/release_0.9/OpenRGB_0.9_x86_64_b5f46e3.AppImage
    dest: /usr/local/bin/openrgb
    mode: '0755'
  become: true
  when: openrgb_installed.rc != 0
  tags:
    - rgb
    - installation

- name: Detect RGB hardware devices
  command: openrgb --list-devices
  register: rgb_devices_detected
  failed_when: false
  changed_when: false
  tags:
    - rgb
    - detection

- name: Turn all RGB lights off
  command: openrgb -m static -c 000000 --noautoconnect
  when: rgb_lights_state == "off"
  tags:
    - rgb
    - control

- name: Create systemd service for RGB control persistence
  template:
    src: rgb-control.service.j2
    dest: /etc/systemd/system/rgb-control.service
    mode: '0644'
  become: true
  tags:
    - rgb
    - persistence

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: true
  tags:
    - rgb
    - persistence

- name: Enable RGB control service for autostart
  systemd:
    name: rgb-control.service
    enabled: yes
    state: started
  become: true
  tags:
    - rgb
    - persistence
