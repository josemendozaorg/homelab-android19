---
# AdGuard Home configuration tasks
# Container is provisioned by Terraform, this role only handles configuration
# Assumes AdGuard container already exists and is running

- name: Set container ID from catalog
  set_fact:
    container_id: "{{ adguard_container_id }}"

- name: Wait for AdGuard container to be ready
  shell: pct status {{ container_id }} | grep running
  register: container_ready
  until: container_ready.rc == 0
  retries: 30
  delay: 2

- name: Wait for network connectivity in container
  shell: pct exec {{ container_id }} -- ping -c 1 8.8.8.8
  register: network_test
  until: network_test.rc == 0
  retries: 15
  delay: 2

- name: Check if AdGuard Home is installed
  shell: pct exec {{ container_id }} -- systemctl status AdGuardHome
  register: adguard_service_status
  failed_when: false
  changed_when: false

- name: Install AdGuard Home if not present
  shell: |
    pct exec {{ container_id }} -- bash -c "
      apt update &&
      apt install -y curl wget sudo &&
      cd /opt &&
      curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh
    "
  register: adguard_installation
  when: adguard_service_status.rc != 0

- name: Enable and start AdGuard Home service
  shell: |
    pct exec {{ container_id }} -- systemctl enable AdGuardHome
    pct exec {{ container_id }} -- systemctl start AdGuardHome
  when: adguard_service_status.rc != 0

- name: Wait for AdGuard Home web interface
  wait_for:
    host: "{{ adguard_static_ip }}"
    port: "{{ adguard_web_port }}"
    timeout: 30
  delegate_to: localhost

- name: Wait for container initialization
  pause:
    seconds: 10

- name: Get AdGuard container information
  shell: |
    CONTAINER_ID=$(pct list | grep -i adguard | awk '{print $1}' | head -1)
    if [ -n "$CONTAINER_ID" ]; then
      echo "Container ID: $CONTAINER_ID"
      echo "Container Status: $(pct status $CONTAINER_ID)"
      CONTAINER_IP=$(pct exec $CONTAINER_ID -- hostname -I 2>/dev/null | awk '{print $1}' || echo "IP retrieval failed")
      echo "Container IP: $CONTAINER_IP"
      echo "Web Interface: http://$CONTAINER_IP:{{ adguard_web_port }}"
      echo "DNS Server: $CONTAINER_IP:{{ adguard_dns_port }}"
    else
      echo "No AdGuard container found"
      exit 1
    fi
  register: container_info
  changed_when: false

- name: Check if AdGuard Home needs initial configuration
  uri:
    url: "http://{{ adguard_static_ip }}:{{ adguard_web_port }}/"
    method: GET
    status_code: [200, 302]
  delegate_to: localhost
  register: adguard_status
  failed_when: false

- name: Configure AdGuard Home via API (if not already configured)
  uri:
    url: "http://{{ adguard_static_ip }}:{{ adguard_web_port }}/control/install/configure"
    method: POST
    body_format: json
    body:
      web:
        ip: "{{ adguard_web_bind }}"
        port: "{{ adguard_web_port }}"
        status: ""
      dns:
        ip: "{{ adguard_dns_bind }}"
        port: "{{ adguard_dns_port }}"
        status: ""
        autofix: false
      username: "{{ adguard_admin_username }}"
      password: "{{ adguard_admin_password }}"
    status_code: 200
  delegate_to: localhost
  register: adguard_config
  failed_when: false
  when: "'install.html' in (adguard_status.content | default(''))"

- name: Display AdGuard Home installation summary
  debug:
    msg:
      - "🎉 AdGuard Home installation completed!"
      - "{{ container_info.stdout_lines if container_info is defined else ['Container ID: ' + container_id, 'Container Status: running', 'Container IP: ' + adguard_static_ip + ' (static)', 'Web Interface: http://' + adguard_static_ip + ':' + (adguard_web_port | string), 'DNS Server: ' + adguard_static_ip + ':' + (adguard_dns_port | string)] }}"
      - ""
      - "🔐 Admin Configuration:"
      - "Username: {{ adguard_admin_username }}"
      - "Password: {{ adguard_admin_password }}"
      - ""
      - "📋 Configuration Status:"
      - "Configuration completed - ready to use"
      - ""
      - "📋 Next steps:"
      - "1. Login to web interface with credentials above"
      - "2. Add custom DNS rewrites as needed"
      - "3. Configure additional filters if desired"
      - "4. Update your router/DHCP to use AdGuard as DNS server"